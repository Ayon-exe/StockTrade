// ... (Imports and firebaseConfig remain unchanged) ...

onAuthStateChanged(auth, (user) => {
    if (user) {
        uid = user.uid;
        userRef = ref(database, 'users/' + uid);
        transactionsRef = ref(database, 'users/' + uid + '/transactions');
        fetchUserData();
    }
});

function fetchUserData() {
    // ... (User info fetching remains unchanged) ...

    get(transactionsRef).then((snapshot) => {
        const transactionsData = snapshot.val();
        let transactionsHtml = '';
        let stockTotals = {}; // Object to store total stocks owned for each company

        // ... (Transaction loop remains unchanged) ...

        // Display transactions and stock totals on the page
        document.getElementById('transactionsTable').innerHTML = transactionsHtml;

        // Add a section to display total stocks owned for each company
        let stockTotalsHtml = '<h2>Total Stocks Owned</h2><ul>';
        for (const company in stockTotals) {
            stockTotalsHtml += `<li>${company}: ${stockTotals[company]}</li>`;
        }
        stockTotalsHtml += '</ul>';
        document.getElementById('stockTotals').innerHTML = stockTotalsHtml;

        // Sorting and filtering functions
        function sortTransactionsByAmount(transactionsData) {
            return transactionsData.sort((a, b) => a.amount - b.amount);
        }

        function sortTransactionsByDate(transactionsData) {
            return transactionsData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function filterTransactionsByDate(transactionsData, startDate, endDate) {
            return transactionsData.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                return transactionDate >= new Date(startDate) && transactionDate <= new Date(endDate);
            });
        }

        document.getElementById('sortAmount').addEventListener('click', function() {
            const sortedTransactions = sortTransactionsByAmount(Object.values(transactionsData));
            renderTransactions(sortedTransactions);
        });

        document.getElementById('sortDate').addEventListener('click', function() {
            const sortedTransactions = sortTransactionsByDate(Object.values(transactionsData));
            renderTransactions(sortedTransactions);
        });

        document.getElementById('filterDate').addEventListener('click', function() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const filteredTransactions = filterTransactionsByDate(Object.values(transactionsData), startDate, endDate);
            renderTransactions(filteredTransactions);
        });

        function renderTransactions(transactions) {
            let transactionsHtml = '';
            for (const transaction of transactions) {
                transactionsHtml += `
                    <tr>
                        <td>${transaction.type}</td>
                        <td>${transaction.amount}</td>
                        <td>${transaction.price}</td>
                        <td>${transaction.timestamp}</td>
                        <td>${transaction.company}</td>
                        <td>${transaction.amount * (transaction.type === 'buy' ? 1 : -1)}</td>
                    </tr>
                `;
            }
            document.getElementById('transactionsTable').innerHTML = transactionsHtml;
        }
    });

    document.getElementById('Clear').addEventListener('click', function() {
        // ... (Clearing transactions remains unchanged) ...
    });
}
</script>
</body>
</html>
